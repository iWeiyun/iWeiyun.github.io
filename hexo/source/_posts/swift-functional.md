---
title: Swiftå‡½æ•°å¼ç¼–ç¨‹æ¢ç´¢
date: 2018-11-19 20:16:54
author: sniper
tags: swift,functional
---



ä»¥å‰åœ¨iOSä¸Šï¼Œé™¤äº†RACï¼Œæ¯”è¾ƒå°‘æœ‰å‡½æ•°å¼ç¼–ç¨‹æ–¹é¢çš„å®è·µã€‚swiftå¯¹å‡½æ•°å¼åšäº†è¾ƒå¤šçš„æ”¯æŒï¼Œéšç€swiftçš„æ™®åŠï¼Œåœ¨iOSç¤¾åŒºï¼Œå‡½æ•°å¼ç¼–ç¨‹è¢«è¶Šæ¥è¶Šå¤šçš„å¼€å‘è€…æ‰€æ¥å—ã€‚å¹¶ä¸”å› ä¸ºå‡½æ•°å¼ç¼–ç¨‹çš„ä¸€äº›ä¼˜ç‚¹ï¼Œä¹Ÿè¶Šæ¥è¶Šå¤šçš„è¯­è¨€å¼€å§‹æ”¯æŒå‡½æ•°å¼çš„å¼€å‘èŒƒå¼ã€‚

å› ä¸ºæœ€è¿‘ä¹Ÿåœ¨é¡¹ç›®ä¸­å¼€å§‹å®è·µå‡½æ•°å¼ç¼–ç¨‹ï¼Œä¹Ÿèƒ½é€æ¸æ„Ÿå—åˆ°å‡½æ•°å¼å¼ºå¤§ä¹‹å¤„ã€‚ç›®å‰ä¹Ÿæœ‰ä¸€ç‚¹å¿ƒå¾—ï¼Œæœ¬æ–‡å°±è°ˆä¸‹è‡ªå·±å¯¹å‡½æ•°å¼ç¼–ç¨‹çš„ç†è§£ã€‚
â€‹	
ä¸è¿‡åœ¨å¼€å§‹ä¹‹å‰ï¼Œå…ˆæ¨èä¸ªå°æ®µå­ï¼š[å¥½ä¹…ä¸è§](http://m.youku.com/video/id_XMzUwMzg4NDAyNA==.html?spm=a2h0k.8191407.0.0&source=&sharetype=2&from=groupmessage&isappinstalled=0)

â€‹		

------



### ç¼–ç¨‹èŒƒå¼

åœ¨è®²å‡½æ•°å¼ç¼–ç¨‹ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹çœ‹è¿™ä¸¤å¤§ç¼–ç¨‹èŒƒå¼ï¼š

- å‘½ä»¤å¼
- å£°æ˜å¼

æ¥ç²˜è´´ä¸€ä¸ªå…³äºå®ƒä»¬çš„å®šä¹‰ï¼š

> å‘½ä»¤å¼ç¼–ç¨‹é€šè¿‡ä¸€ç³»åˆ—æ”¹å˜ç¨‹åºçŠ¶æ€çš„æŒ‡ä»¤æ¥å®Œæˆè®¡ç®—ã€‚å‘½ä»¤å¼ç¼–ç¨‹æ¨¡æ‹Ÿç”µè„‘è¿ç®—ï¼Œæ˜¯è¡ŒåŠ¨å¯¼å‘çš„ï¼Œå…³é”®åœ¨äºå®šä¹‰è§£æ³•ï¼Œå³â€œæ€ä¹ˆåšâ€ï¼Œå› è€Œç®—æ³•æ˜¯æ˜¾æ€§è€Œç›®æ ‡æ˜¯éšæ€§çš„ã€‚
>
> å£°æ˜å¼ç¼–ç¨‹åªæè¿°ç¨‹åºåº”è¯¥å®Œæˆçš„ä»»åŠ¡ã€‚å£°æ˜å¼ç¼–ç¨‹æ¨¡æ‹Ÿäººè„‘æ€ç»´ï¼Œæ˜¯ç›®æ ‡é©±åŠ¨çš„ï¼Œå…³é”®åœ¨äºæè¿°é—®é¢˜ï¼Œå³â€œåšä»€ä¹ˆâ€ï¼Œå› è€Œç›®æ ‡æ˜¯æ˜¾æ€§è€Œç®—æ³•æ˜¯éšæ€§çš„ã€‚

è¿™ä¸¤ç§èŒƒå¼çš„å…³é”®åŒºåˆ«å°±åœ¨äºï¼Œä¸€ä¸ªä¸»è¦è¡¨è¾¾â€œæ€ä¹ˆåšâ€ï¼Œä¸€ä¸ªä¸»è¦è¡¨è¾¾â€œåšä»€ä¹ˆâ€ã€‚é€šè¿‡ä¸¤æ®µä»£ç ï¼Œå¯ä»¥ç›´è§‚çš„æ„Ÿå—ä¸€ä¸‹å®ƒä»¬çš„åŒºåˆ«ï¼š
![å‘½ä»¤å¼](/images/swift-functional/1542568661_33.png)
![å£°æ˜å¼](/images/swift-functional/1542568666_91.png)
è¿™ä¸¤æ®µä»£ç éƒ½æ˜¯åšçš„åŒä¸€ä»¶äº‹ï¼ŒæŠŠæ•°ç»„é‡Œæ¯ä¸ªå…ƒç´ éƒ½ä¹˜2ï¼Œå†æ‰“å°å‡ºæ¥ã€‚
å¯ä»¥çœ‹å‡ºæ¥ï¼Œæˆ‘ä»¬å¹³æ—¶ä½¿ç”¨çš„ä¸»è¦éƒ½æ˜¯å‘½ä»¤å¼çš„å†™æ³•ï¼ŒåŒ…æ‹¬ä½¿ç”¨çš„æœ€å¤šçš„é¢å‘å¯¹è±¡ç¼–ç¨‹(OOP)ï¼Œå…¶å®è¿˜æ˜¯å±äºå‘½ä»¤å¼ç¼–ç¨‹çš„èŒƒç•´ã€‚è€Œè¿™ç¯‡æ–‡ç« è¦è®²çš„å‡½æ•°å¼ç¼–ç¨‹ï¼Œåˆ™æ˜¯å±äºå£°æ˜å¼ç¼–ç¨‹ã€‚

â€‹	

------



### å‡½æ•°å¼ç¼–ç¨‹çš„ä¼˜åŠ¿

- å‡è½»ç¨‹åºå‘˜æ€è€ƒçš„è´Ÿæ‹…ï¼ˆé˜²ç§ƒï¼‰ï¼Œé™ä½å‡ºé”™çš„å¯èƒ½æ€§

å°±æ‹¿ä¸Šé¢ä¸¾çš„ä¾‹å­æ¥è¯´ï¼Œå…ˆä¸è¯´ä¸€çœ¼æœ›å»ï¼Œå‘½ä»¤å¼å†™æ³•çš„å¤æ‚æ€§å°±æ˜æ˜¾è¦é«˜å¾—å¤šï¼Œå³ä½¿æ˜¯ä¸€ä¸ªå¦‚æ­¤ç®€å•çš„é€»è¾‘ï¼Œä¹Ÿå®¹æ˜“å†™å‡ºé”™è¯¯ã€‚
å½“æ—¶å†™è¿™ä¸ªä¾‹å­çš„æ—¶å€™ï¼Œä¸ºäº†çªå‡ºå®ƒä»¬çš„åŒºåˆ«ï¼Œæˆ‘æ•…æ„æ²¡ç”¨for in rangeè¿™ç§æ¯”è¾ƒå¸¸è§„çš„å†™æ³•ï¼Œè€Œä½¿ç”¨äº†whileï¼Œè‡ªå·±ç»´æŠ¤indexã€‚ç„¶é¹…ç¬¬ä¸€æ¬¡è·‘èµ·æ¥å°±æ­»å¾ªç¯äº†ï¼Œå†æ£€æŸ¥ï¼Œå‘ç°æ˜¯çº¢æ¡†é‡Œçš„indexåŠ 1æ¼äº†å†™ã€‚
å‡½æ•°å¼å†™æ³•ä¸­ï¼Œå› ä¸ºæ²¡æœ‰äº†çŠ¶æ€çš„ç»´æŠ¤ï¼Œæœç»äº†è¿™ç§é”™è¯¯çš„å‘ç”Ÿã€‚

- ä»£ç å¯è¯»æ€§é«˜
- æ›´ç®€æ´ã€æ›´å°‘çš„ä»£ç 

çœ‹å›å®šä¹‰ï¼Œå£°æ˜å¼ç¼–ç¨‹æè¿°â€œåšä»€ä¹ˆâ€ï¼Œç›®æ ‡æ˜¯æ˜¾æ€§è€Œç®—æ³•æ˜¯éšæ€§çš„ã€‚è€Œé˜…è¯»ä»£ç æ—¶æˆ‘ä»¬å¾€å¾€åªå…³å¿ƒä»£ç åšäº†ä»€ä¹ˆï¼Œè€Œä¸å…³å¿ƒæ€ä¹ˆåšï¼Œè¿™ä¸å£°æ˜å¼ç¼–ç¨‹çš„æ€æƒ³æ˜¯ä¸è°‹è€Œåˆçš„ï¼Œæ‰€ä»¥å‡½æ•°å¼ç¼–ç¨‹å…·æœ‰æ›´é«˜çš„ä»£ç å¯è¯»æ€§ã€‚
åŒæ—¶ä¸ºäº†å®ç°è¿™ç§æ€æƒ³ï¼Œç®—æ³•çš„å®ç°å¾€å¾€æ˜¯å†…å»ºçš„ï¼Œæˆ–æ˜¯éšè—çš„ï¼Œè¿™ä¹Ÿè®©å‡½æ•°å¼çš„å®ç°å…·æœ‰æ›´å°‘çš„ä»£ç ï¼Œçœ‹èµ·æ¥æ›´ç®€æ´ã€‚

- é€‚ç”¨äºå¹¶å‘ç¯å¢ƒ
- æ˜“äºä¼˜åŒ–

å‡½æ•°å¼ç¼–ç¨‹ä¸­æ‰€ä½¿ç”¨çš„å‡½æ•°ï¼Œå¤§å¤šè¦æ±‚ä¸ºçº¯å‡½æ•°ï¼Œè¿™é‡Œå¯ä»¥å…ˆç†è§£ä¸ºæ•°å­¦æ„ä¹‰ä¸Šçš„å‡½æ•°ï¼Œåœ¨ç›¸åŒçš„å‚æ•°è¾“å…¥çš„æƒ…å†µä¸‹ï¼Œä¸€å®šä¼šæœ‰åŒæ ·çš„è¾“å‡ºã€‚
è¿™ä¸€ç‰¹ç‚¹å†³å®šäº†çº¯å‡½æ•°å¯ä»¥å¹¶è¡Œçš„è°ƒç”¨ï¼Œè€Œæ— éœ€ä»»ä½•ä¿®æ”¹ï¼Œå› ä¸ºæ— è®ºå¹¶è¡Œä¸å¦ï¼Œå®ƒéƒ½èƒ½è¾“å‡ºæ­£ç¡®çš„ç»“æœã€‚
![å¹¶å‘](/images/swift-functional/1542597555_48.png)
ä¸Šå›¾parallelMapå‡½æ•°çš„å®ç°å°±æ˜¯å°†æ•°ç»„åˆ†æˆå¤šæ®µï¼Œç„¶ååœ¨å¤šä¸ªçº¿ç¨‹ä¸­åˆ†åˆ«è°ƒç”¨mapï¼Œæœ€åå†æ‹¼å›ä¸€æ•´ä¸ªã€‚é€šè¿‡è¿™ä¸€ç‚¹æ”¹åŠ¨ï¼Œå°±ç®€å•çš„å¯¹è¿™ä¸ªç¨‹åºè¿›è¡Œäº†å¤šçº¿ç¨‹çš„æ€§èƒ½ä¼˜åŒ–ã€‚

- ç»†ç²’åº¦çš„é‡ç”¨ï¼ˆå‡½æ•°çº§åˆ«ï¼‰
- æ˜“äºæµ‹è¯•

çº¯å‡½æ•°é™¤äº†ä¹‹å‰è¯´çš„ï¼Œè¿˜è¦æ±‚â€œæ²¡æœ‰ä»»ä½•å¯è§‚å¯Ÿçš„å‰¯ä½œç”¨ï¼Œä¸ä¾èµ–å¤–éƒ¨ç¯å¢ƒçš„çŠ¶æ€â€ã€‚
ååŠè¿˜æ˜¯å®¹æ˜“ç†è§£çš„ï¼Œå› ä¸ºåªè¦ä¾èµ–äº†å¤–éƒ¨ç¯å¢ƒï¼Œå°±ä¸èƒ½ä¿è¯ç›¸åŒè¾“å…¥å¾—åˆ°ç›¸åŒè¾“å‡ºäº†ã€‚
å‰åŠæ‰€è¯´çš„å‰¯ä½œç”¨ï¼Œæ˜¯æŒ‡é™¤äº†è¿”å›å€¼å¤–ï¼Œå‡½æ•°è¿˜é€šè¿‡å…¶ä»–æ–¹å¼å¯¹è°ƒç”¨ç¯å¢ƒäº§ç”Ÿäº†å½±å“ï¼Œä¾‹å¦‚ä¿®æ”¹å…¨å±€å˜é‡ï¼Œå†™æ–‡ä»¶ï¼Œprintåˆ°æ§åˆ¶å°ç­‰ç­‰ã€‚
çº¯å‡½æ•°å¾ˆå®¹æ˜“è¿›è¡Œå•å…ƒæµ‹è¯•ï¼Œåªéœ€å…³å¿ƒè¾“å…¥è¾“å‡ºå³å¯ã€‚é‡ç”¨ä¹Ÿæ˜¯åŒç†ï¼Œä¸å¿…è€ƒè™‘è°ƒç”¨çš„é¡ºåºï¼Œä¸ç”¨æ‹…å¿ƒå½±å“åç»­é€»è¾‘ï¼Œæ”¾å¿ƒçš„å¤ç”¨ã€‚
![å‡½æ•°é‡ç”¨](/images/swift-functional/1542614984_40.png)

- æ˜“äºé‡æ„

åŸå› ä¹Ÿå°±æ˜¯å‰é¢è¯´çš„é‚£äº›ï¼Œçº¯å‡½æ•°ä¹‹é—´çš„ä¾èµ–å…³ç³»å°±æ˜¯ä¸€ä¸ªæ ‘ï¼Œå¾ˆå®¹æ˜“ç†æ¸…ã€‚è€Œå¯¹è±¡ä¹‹é—´çš„ä¾èµ–å°±å¤æ‚å¾—å¤šï¼Œåšè¿‡é‡æ„çš„åŒå­¦åº”è¯¥éƒ½æœ‰ä½“ä¼šï¼Œå¦‚æœæ²¡æœ‰æŠŠä»£ç çœ‹çš„å¾ˆç†Ÿï¼Œæ˜¯ä¸æ•¢è½»æ˜“å»åŠ¨çš„ã€‚ä¹¦é‡Œæœ‰ä¸€å¥è¯æ€»ç»“çš„å¾ˆåˆ°ä½ï¼š
![FPå’ŒOO](/images/swift-functional/1542615515_42.png)

â€‹	

-----



### å‡½æ•°å¼ç¼–ç¨‹æŒ‡å—

æ¦‚å¿µéƒ½äº†è§£äº†ï¼Œé‚£è¦æ€ä¹ˆåº”ç”¨åˆ°å®é™…çš„é¡¹ç›®ä¸­å‘¢ï¼Ÿåªè¦åœ¨ç¼–å†™ä»£ç æ—¶ï¼Œå¾€ä¸‹é¢è¿™å‡ ç‚¹é ï¼Œè‡ªç„¶å°±èƒ½å†™å‡ºå‡½æ•°å¼é£æ ¼çš„ä»£ç äº†ï¼š

- åªå®šä¹‰çº¯å‡½æ•°
- ä¸è¦ç”¨å¯å˜é‡
- é€’å½’ä»£æ›¿è¿­ä»£
- å°½é‡å°‘çš„æ•°æ®ç»“æ„
- é—­åŒ…ã€é«˜é˜¶å‡½æ•°çš„åº”ç”¨
- å°½å¯èƒ½ä½¿ç”¨å†…ç½®çš„æ•°æ®ç»“æ„
- å°½å¯èƒ½ä½¿ç”¨å†…ç½®çš„å‡½æ•°å¼å·¥å…·

ä½†æ˜¯å¹¶éæ‰€æœ‰åŠŸèƒ½éƒ½é€‚åˆç”¨å‡½æ•°å¼æ¥ç¼–å†™ï¼Œå¾ˆå¤šæƒ…å†µä¸‹å‰¯ä½œç”¨æ˜¯æ— æ³•é¿å…çš„ï¼š

> å‡½æ•°å¼è¯­è¨€å’Œé€»è¾‘å¼è¯­è¨€æ“…é•¿åŸºäºæ•°ç†é€»è¾‘çš„åº”ç”¨ï¼Œå‘½ä»¤å¼è¯­è¨€æ“…é•¿åŸºäºä¸šåŠ¡é€»è¾‘çš„ã€å°¤å…¶æ˜¯äº¤äº’å¼æˆ–äº‹ä»¶é©±åŠ¨å‹çš„åº”ç”¨ã€‚

ç°é˜¶æ®µé‡åˆ°è¿™äº›æƒ…å†µæ—¶ï¼Œè¿˜æ˜¯ä¸è¦å¼ºè¡Œåº”ç”¨å‡½æ•°å¼äº†ï¼Œç‰¹åˆ«æ˜¯è‹¹æœçš„ç³»ç»Ÿæ¡†æ¶è¿˜æ˜¯åŸºäºé¢å‘å¯¹è±¡çš„ã€‚

â€‹	
æ¥ä¸‹æ¥ä¸¾ä¸ªğŸŒ°ï¼š
æˆ‘ä»¬é¡¹ç›®ä¸­æœ‰è¿™æ ·ä¸€ä¸ªéœ€æ±‚ï¼Œåœ¨ä¸€ä¸ªåˆ—è¡¨ä¸­ï¼Œæœ‰å¤šç§å…ƒç´ ï¼ˆæ–‡ä»¶ã€æ–‡ä»¶å¤¹ã€ç¬”è®°ç­‰ï¼‰ã€‚è¿˜æœ‰å¤šç§æ“ä½œï¼Œæ¯ç§æ“ä½œæ”¯æŒçš„ç±»å‹ã€æ•°é‡ä¸åŒã€‚ç°åœ¨é€‰ä¸­äº†ä¸€äº›å…ƒç´ ï¼Œæ±‚èƒ½å¯¹è¿™äº›å…ƒç´ è¿›è¡Œå“ªäº›æ“ä½œã€‚
ä¾‹å¦‚ï¼Œé€‰ä¸­ä¸€ä¸ªæ–‡ä»¶ã€ä¸€ä¸ªæ–‡ä»¶å¤¹ï¼Œè¿™æ—¶å¯ä»¥è¿›è¡Œç§»åŠ¨æ“ä½œï¼ˆæ‰¹é‡ã€ä¸æ”¯æŒç¬”è®°ï¼‰ï¼Œä½†ä¸èƒ½è¿›è¡Œé‡å‘½åæ“ä½œï¼ˆåªæ”¯æŒå•ä¸ªï¼‰ã€‚
è¿™æ˜¯ä¸€ä¸ªå¾ˆå¸¸è§çš„éœ€æ±‚ï¼Œå¹¶ä¸”ä¸æ¶‰åŠUIã€äº¤äº’ï¼Œé€‚åˆç”¨å‡½æ•°å¼æ¥æ”¹é€ ä¸€ä¸‹ã€‚

â€‹	

æœ€ç»ˆæˆ‘ä»¬éœ€è¦è¿™æ ·ä¸€ä¸ªä¸œè¥¿ï¼Œè¾“å…¥é€‰æ‹©çš„å…ƒç´ åˆ—è¡¨ï¼Œå¾—åˆ°æ”¯æŒçš„æ“ä½œé›†åˆã€‚æˆ‘ä»¬æŠŠå®ƒå®šä¹‰æˆStrategyç±»å‹ï¼Œæ˜¯ä¸€ç±»å‡½æ•°ï¼Œåœ¨å‡½æ•°å¼ç¼–ç¨‹é‡Œï¼Œå‡½æ•°å°±æ˜¯ä¸€ç­‰å…¬æ°‘ã€‚

```swift
typealias Strategy = (_ items: [Any]) -> Set<WYOperationType>
```

å…‰æœ‰Strategyè¿˜ä¸å¤Ÿï¼Œæˆ‘ä»¬è¦ç›´æ¥å®ç°è¿™æ ·ä¸€ä¸ªå‡½æ•°è¿˜æ˜¯å¤ªè¿‡å¤æ‚ï¼Œè€Œä¸”ä¹Ÿä¸å¤Ÿçµæ´»ï¼Œéœ€è¦æŠŠå®ƒæ‹†è§£ä¸ºæ›´å°çš„å•å…ƒã€‚
æˆ‘é‡‡ç”¨çš„æ–¹æ³•æ˜¯ï¼Œå…ˆå®šä¹‰ä¸€ä¸ªé»˜è®¤çš„æ“ä½œé›†åˆï¼ŒåŒ…å«äº†æœ€å¸¸è§„çš„æ“ä½œã€‚ç„¶åå®šä¹‰ä¸€äº›Modifieræ¥ä¿®æ”¹é»˜è®¤çš„æ“ä½œé›†åˆã€‚ä¸åŒç±»å‹çš„å…ƒç´ æ”¯æŒå“ªäº›æ“ä½œå°±å®šä¹‰åœ¨ä¸åŒçš„Modifieré‡Œã€‚

```swift
static let defaultStrategy: Strategy = { _ in
	[.delete, .share, .safeBoxMoveIn,
     .safeBoxMoveOut, .shareDirWithFriend, .rename,
     .download, .jumpToDir, .openIn,
     .favour, .move, .inbox, .unInbox,
     .fileInfo, .ocr, .groupMove,
     .noteGroup, .genPDF, .genGIF]
}

typealias Modifier = (_ items: [Any], _ operations: Set<WYOperationType>) -> Set<WYOperationType>

class func modify(_ strategy: @escaping Strategy, _ modifier: @escaping Modifier) -> Strategy {
    return { items in
        modifier(items, strategy(items))
    }
}
```

è¿™é‡Œçš„modifyå‡½æ•°ï¼Œå…¶å®å°±æ˜¯ä¸€ä¸ªå¸¦itemså‚æ•°çš„composeï¼ˆç»„åˆï¼‰æ“ä½œã€‚



ä¸‹é¢æˆ‘ä»¬å°±æ¥å®šä¹‰ä¸€ä¸ªç›®å½•çš„modifierï¼š

```swift
static let dirSupported: Operand = { items in
    let dirs = items.lazy.compactMap { $0 as? WeiyunDir }
    return dirs.first.map {
        if $0.isCollecting() {
            return [.share, .shareDirWithFriend, .safeBoxMoveIn, .move, .inbox, .unInbox, .delete, .rename]
        } else {
            return [.share, .shareDirWithFriend, .safeBoxMoveIn, .move, .inbox, .delete, .rename]
        }
    }
}

static let dirModifier: Modifier = buildModifier(dirSupported, intersection)
```

dirSupportedåˆ¤æ–­itemsä¸­æ˜¯å¦æœ‰ç›®å½•ï¼Œæœ‰çš„è¯å°±è¿”å›ç›®å½•æ”¯æŒçš„æ“ä½œï¼Œé€šè¿‡buildModifierå’Œintersectionï¼Œæ„é€ äº†ä¸€ä¸ªâ€œå¦‚æœå«æœ‰ç›®å½•ï¼Œå°±å°†ç›®å‰çš„æ“ä½œé›†åˆä¸ç›®å½•æ”¯æŒçš„æ“ä½œé›†åˆå–äº¤é›†â€çš„ä¸€ä¸ªModifierã€‚
è€ƒè™‘åˆ°Modifierå…¶å®ä¹Ÿå°±åªæœ‰æ”¯æŒã€ä¸æ”¯æŒã€æ·»åŠ ä¸‰ç§æƒ…å†µï¼Œåˆ†åˆ«å¯¹åº”é›†åˆçš„äº¤ã€å·®ã€å¹¶é›†ï¼Œå°±é€šè¿‡â€œè¿”å›æ“ä½œé›†åˆâ€çš„Operandå‡½æ•°ï¼Œå’Œä¸‰ç§SetOperationæ¥buildä¸€ä¸ªModifierï¼Œå°†Modifierçš„é€»è¾‘ä¹Ÿç»†åˆ†ï¼š

```swift
typealias SetOperation = (_ first: Set<WYOperationType>, _ second: Set<WYOperationType>) -> Set<WYOperationType>

static let union: SetOperation = { $0.union($1) }
static let subtracting: SetOperation = { $0.subtracting($1) }
static let intersection: SetOperation = { $0.intersection($1) }

typealias Operand = (_ items: [Any]) -> Set<WYOperationType>?

class func buildModifier(_ operand: @escaping Operand, _ setOperation: @escaping SetOperation) -> Modifier {
    return { items, operations in
        if let ret = operand(items) {
            return setOperation(operations, ret)
        }
        return operations
    }
}
```

ä¸‹é¢å®šä¹‰äº†å‡ ä¸ªç”¨äºå°†Modifierè¿›è¡Œç»„åˆçš„å‡½æ•°ï¼š

```swift
static let emptyModifier: Modifier = { $1 }

class func concat(_ modifierLeft: @escaping Modifier, _ modifierRight: @escaping Modifier) -> Modifier {
    return { items, operations in
        return modifierRight(items, modifierLeft(items, operations))
    }
}

class func concatModifiers(_ modifiers: [Modifier]) -> Modifier {
    return modifiers.reduce(emptyModifier) { concat($0, $1) }
}
```



æœ‰äº†Modifierçš„composeå‡½æ•°ï¼Œå°±å¯ä»¥å®šä¹‰æ›´å¤æ‚çš„æ–‡ä»¶å’Œç¬”è®°çš„Modifieräº†ã€‚
æœ€åè¿˜æœ‰ä¸€ä¸ªcountçš„Modifierï¼Œæ˜¯ä¸“é—¨ç”¨æ¥åœ¨å¤šé€‰çš„æƒ…å†µä¸‹ï¼Œå»é™¤åªæ”¯æŒå•å…ƒç´ çš„æ“ä½œã€‚

```swift
static let fileSupported: Operand = { items in
    let files = items.lazy.filter { !($0 is WeiyunNote) }.compactMap { $0 as? WeiyunFile }
    return files.first.map { _ in
        [.download, .share, .shareDirWithFriend,
         .fileInfo, .safeBoxMoveIn, .move,
         .jumpToDir, .delete, .favour,
         .rename, .openIn, .ocr,
         .groupMove, .genGIF]
    }
}

static let fileUnsupported: Operand = { items in
    let files = items.lazy.filter { !($0 is WeiyunNote) }.compactMap { $0 as? WeiyunFile }
    let noOcr = files.filter { !$0.isShouldShowOCRAction() }.first
    let noImgVid = files.filter { !$0.isImageFile() && !$0.isVideoFile() }.first
    let noLivePhoto = files.filter { !$0.isLivePhoto }.first
    let secondFile = files.dropFirst().first

    let result: [WYOperationType] = (noOcr != nil ? [.ocr] : []) + (noImgVid != nil ? [.groupMove, .genGIF] : []) + (noLivePhoto != nil ? [.genGIF] : []) + (secondFile != nil ? [.genGIF] : [])
    return Set<WYOperationType>(result)
}

static let fileModifier: Modifier = concatModifiers([buildModifier(fileSupported, intersection), buildModifier(fileUnsupported, subtracting)])

static let noteSupported: Operand = { items in
    let notes = items.lazy.compactMap { $0 as? WeiyunNote }
    return notes.first.map { _ in
        return [.share, .delete, .noteGroup, .favour]
    }
}

static let noteUnsupported: Operand = { items in
    let notes = items.lazy.compactMap { $0 as? WeiyunNote }
    return notes.dropFirst().first.map { _ in
        return [.favour]
    }
}

static let noteModifier: Modifier = concatModifiers([buildModifier(noteSupported, intersection), buildModifier(noteUnsupported, subtracting)])

static let countUnsupported: Operand = { items in
    let wyItems = items.lazy.compactMap { $0 as? WeiyunItem }
    return wyItems.dropFirst().first.map { _ in
        return [.ocr, .fileInfo, .rename, .jumpToDir, .openIn, .inbox, .unInbox]
    }
}

static let countModifier: Modifier = buildModifier(countUnsupported, subtracting)
```

æœ€åå®šä¹‰ä¸€ä¸ªapplyModifiersæ¥åº”ç”¨ä¸€ç»„Modifierï¼š

```swift
class func applyModifiers(_ strategy: @escaping Strategy, _ modifiers: [Modifier]) -> Strategy {
    return modifiers.reduce(strategy) { modify($0, $1) }
}

static let filesTabStrategy: Strategy = applyModifiers(defaultStrategy, [dirModifier, fileModifier, noteModifier, countModifier])
```

filesTabStrategyå°±å¯ä»¥æ‹¿åˆ°æˆ‘ä»¬APPçš„æ–‡ä»¶åˆ—è¡¨å»ç”¨äº†ï¼Œé€‰ä¸­ä¸€äº›é¡¹ç›®åï¼Œæ ¹æ®Strategyè¿”å›çš„æ“ä½œé›†åˆæ¥å±•ç¤ºæ“ä½œèœå•ã€‚
å¦‚æœå…¶ä»–åœºæ™¯æœ‰ä¸åŒçš„éœ€æ±‚ï¼Œå¯ä»¥ç¼–å†™è‡ªå·±çš„Modifierï¼Œå†ä¸ç°æœ‰çš„ä¸€é¡¿ç»„åˆå³å¯ã€‚



ä¸»è¦æ€æƒ³å°±æ˜¯æŠŠå‡½æ•°ã€é—­åŒ…ä½œä¸ºæ•°æ®æ¥æ“ä½œï¼Œè¿ç”¨äºé«˜é˜¶å‡½æ•°ã€‚è¿˜è¦ç†Ÿæ‚‰å‡½æ•°å¼ç¼–ç¨‹çš„ä¸‰æ¿æ–§ï¼ˆmapã€filterã€reduceï¼‰å’Œlazyç­‰å‡½æ•°å¼å·¥å…·ï¼Œéµå¾ªå¼€å¤´çš„é‚£å‡ ä¸ªè¦ç‚¹æ¥ç¼–å†™ä»£ç ï¼Œå°±ç®—æ˜¯å…¥äº†å‡½æ•°å¼çš„å¤§é—¨äº†ã€‚

â€‹	

-----



### å…¶ä»–

- çº¯å‡½æ•°çš„å¼•ç”¨é€æ˜
  å¼•ç”¨é€æ˜ç½‘ä¸Šæœ‰å¾ˆå¤šç§è§£é‡Šï¼Œå‡½æ•°å¼é‡Œï¼Œæ˜¯æŒ‡å‡½æ•°è¿è¡Œçš„ç»“æœä¸å‡½æ•°æœ¬èº«ï¼Œæ˜¯å¯ä»¥äº’ç›¸æ›¿ä»£çš„ã€‚æ˜¾ç„¶çº¯å‡½æ•°æ˜¯å…·æœ‰å¼•ç”¨é€æ˜æ€§çš„ï¼Œæ‰€ä»¥å¯ä»¥å»¶è¿Ÿæ‰§è¡Œè€Œä¸å½±å“ç»“æœï¼Œè¿™æ˜¯lazyèƒ½æ­£ç¡®æ‰§è¡Œçš„ç†è®ºå‰æã€‚

  è¿™é‡Œç»™å‡ºä¸€ä¸ªæ¯”è¾ƒæœ‰æ„æ€çš„lazy filterçš„å®ç°ï¼š
  ![LazyArray](/images/swift-functional/1542626381_77.png)

- è®°å¿†
  å¯ä»¥ç®€å•çš„å¯¹çº¯å‡½æ•°è¿›è¡Œç¼“å­˜ï¼Œæé«˜æ€§èƒ½ã€‚
  Swifté‡Œè™½ç„¶æ²¡æœ‰å†…å»ºçš„å®ç°ï¼Œä½†æ˜¯è‡ªå·±å®ç°ä¸€ä¸ªä¹Ÿå¾ˆç®€å•ï¼š
  ![memorize](/images/swift-functional/1542626458_75.png)
  ç”Ÿäº§ç¯å¢ƒä½¿ç”¨æ—¶è¿˜è¦è€ƒè™‘å†…å­˜å ç”¨ã€æ·˜æ±°ç­‰ã€‚

- é€’å½’ä»£æ›¿è¿­ä»£
  ![é€’å½’](/images/swift-functional/1542626659_3.png)
  è¿™é‡Œå®ç°çš„æ˜¯â€œæ¯éš”1ã€2ã€3ã€4â€¦â€¦ä¸ªæ•°ï¼Œå–ä¸€ä¸ªæ•°â€ã€‚
  ä¸èƒ½ä½¿ç”¨varæ—¶ï¼Œæˆ‘ä»¬éœ€è¦å°†è¿­ä»£æ¢æˆé€’å½’å®ç°ã€‚å¥½å¤„å°±ä¸å†èµ˜è¿°äº†ï¼Œå¹¶ä¸”ç¬¦åˆå‡½æ•°å¼çš„åŸåˆ™ã€‚
  è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯è¦ç”¨ä¸Šå°¾é€’å½’ï¼Œé˜²æ­¢çˆ†æ ˆã€‚
  ç„¶è€Œæˆ‘åœ¨swiftä¸Šæµ‹è¯•æ—¶ï¼Œè¿˜æ˜¯å‡ºç°äº†çˆ†æ ˆçš„æƒ…å†µï¼Œç½‘ä¸ŠæŸ¥äº†èµ„æ–™è¯´æ˜¯swiftä¸ä¿è¯å°¾é€’å½’ä¼˜åŒ–ï¼Œå¥½å§â€¦â€¦

- letçš„æ€§èƒ½é—®é¢˜
  ![æ’å…¥ç™¾ä¸‡æ•°æ®](/images/swift-functional/1542627283_39.png)
  ![å°†åä¸ªæ•°æ®æ’å…¥ç™¾ä¸‡å…ƒç´ çš„å­—å…¸](/images/swift-functional/1542627287_75.png)
  çº¯å‡½æ•°å¼è¯­è¨€å¤§æ¦‚æ˜¯ä¸ä¼šå‡ºç°è¿™æ ·çš„æƒ…å†µçš„ï¼Œè¿è¡Œæ—¶çš„ä¼˜åŒ–ï¼Œæ•°æ®ç»“æ„çš„é«˜åº¦ä¼˜åŒ–ï¼Œç»“æœåº”è¯¥æ˜¯è·Ÿç”¨varå·®ä¸å¤šçš„æ€§èƒ½æ‰å¯¹ã€‚è‡³å°‘ä»¥æˆ‘çš„çŸ¥è¯†ï¼Œéƒ½èƒ½å®ç°ä¸€ä¸ªæ’å…¥æ—¶é—´å¤æ‚åº¦ä¸ºO(log n)çš„ä¸å¯å˜å­—å…¸ã€‚
  swiftä¼°è®¡æ˜¯æ²¡æœ‰åšè¿™æ–¹é¢çš„ä¼˜åŒ–ï¼Œèµ‹å€¼ç»™varæ—¶åº”è¯¥æ˜¯å‘ç”Ÿäº†æ‹·è´ã€‚å¹¶ä¸”letçš„dictä¹Ÿæ²¡æœ‰æ’å…¥ä¸€ä¸ªå€¼ï¼Œè¿”å›ä¸€ä¸ªæ–°let dictçš„æ–¹æ³•ã€‚

- è¿ç®—ç¬¦é‡è½½
  ![è¿ç®—ç¬¦é‡è½½](/images/swift-functional/1542627988_47.png)

- ReactiveX

å°†Asyncã€Lazyã€Multi-threadingç‰ˆæœ¬çš„å‡½æ•°å¼å·¥å…·ï¼Œå¼•å…¥äº†é¢å‘å¯¹è±¡ç¼–ç¨‹ï¼Œéå¸¸å€¼å¾—ä½¿ç”¨ã€‚

â€‹	

-----



### æ€»ç»“

è™½ç„¶è¯´swiftå¼•å…¥äº†è®¸å¤šå‡½æ•°å¼ç¼–ç¨‹çš„ä¸œè¥¿ï¼Œå…‰ä»â€œæ²¡æœ‰å°¾é€’å½’ä¼˜åŒ–â€å’Œâ€œä¸å¯å˜æ•°æ®ç»“æ„ä¼˜åŒ–â€è¿™ä¸¤ç‚¹æ¥çœ‹ï¼Œå®é™…ä¸Šè¿˜æ˜¯ä¸èƒ½å®Œå…¨æŒ‰ç…§çº¯å‡½æ•°å¼è¯­è¨€çš„é‚£ä¸€å¥—æ¥ç¼–ç çš„ã€‚
å‡½æ•°å¼ç¼–ç¨‹ï¼Œç°é˜¶æ®µä¹Ÿè¿˜ä¸ä¼šåœ¨é¡¹ç›®ä¸­å¤§é‡è¿ç”¨ï¼Œä½†æ˜¯è¿™ç§æ€ç»´ï¼Œç¡®å®å¯ä»¥ç»™æˆ‘ä»¬å¹³æ—¶çš„ç¼–ç å¸¦æ¥ä¸ä¸€æ ·çš„å¯å‘ã€‚
ä»¥ç›®å‰swiftçš„èƒ½åŠ›æ¥è¯´ï¼Œä¸€äº›æ¯”è¾ƒç®€å•çš„å‡½æ•°å¼çš„åº”ç”¨è¿˜æ˜¯å¯ä»¥èƒœä»»çš„ã€‚
å³ä½¿åœ¨OOçš„ç¼–ç¨‹ä¸­ï¼Œè¿™äº›å‡½æ•°å¼çš„å·¥å…·ä¹Ÿèƒ½å¤Ÿå¯¹ç®€åŒ–ä»£ç ã€é€»è¾‘èµ·åˆ°å¾ˆå¤§çš„ä½œç”¨ã€‚

â€‹	

----



### å‚è€ƒèµ„æ–™
[ã€Šå‡½æ•°å¼ç¼–ç¨‹æ€ç»´ã€‹](https://www.zhihu.com/pub/reader/119565028)
[ã€ŠSwiftå‡½æ•°å¼ç¼–ç¨‹ã€‹](https://objccn.io/products/functional-swift/)